"""
chat_bot_client.py - AI Chatbot Integration
This file provides integration with AI services (Ollama or OpenAI)
If this file is not present, the system will use the dummy bot in feature_utils.py
"""

# Option 1: Using Ollama (Local AI)
class ChatBotClient:
    """
    Chatbot client using Ollama
    
    Installation:
    1. Download Ollama from https://ollama.ai
    2. Run: ollama pull llama2
    3. pip install requests
    """
    
    def __init__(self, model="llama2", base_url="http://localhost:11434"):
        """
        Initialize Ollama chatbot
        
        Args:
            model: Model name (llama2, mistral, etc.)
            base_url: Ollama API endpoint
        """
        self.model = model
        self.base_url = base_url
        self.conversation_history = []
    
    def chat(self, message):
        """
        Send message to Ollama and get response
        
        Args:
            message: User's message
            
        Returns:
            Bot's response
        """
        try:
            import requests
            
            # Add to conversation history
            self.conversation_history.append({
                "role": "user",
                "content": message
            })
            
            # Make API request
            response = requests.post(
                f"{self.base_url}/api/chat",
                json={
                    "model": self.model,
                    "messages": self.conversation_history,
                    "stream": False
                },
                timeout=30
            )
            
            if response.status_code == 200:
                result = response.json()
                bot_response = result.get("message", {}).get("content", "I couldn't generate a response.")
                
                # Add to conversation history
                self.conversation_history.append({
                    "role": "assistant",
                    "content": bot_response
                })
                
                # Keep only last 10 messages to avoid context overflow
                if len(self.conversation_history) > 20:
                    self.conversation_history = self.conversation_history[-20:]
                
                return bot_response
            else:
                return f"Error: API returned status {response.status_code}"
                
        except ImportError:
            return "Error: 'requests' library not installed. Run: pip install requests"
        except requests.exceptions.ConnectionError:
            return "Error: Cannot connect to Ollama. Make sure Ollama is running."
        except requests.exceptions.Timeout:
            return "Error: Request timed out. The AI might be processing a complex query."
        except Exception as e:
            return f"Error: {str(e)}"
    
    def reset_conversation(self):
        """Clear conversation history"""
        self.conversation_history = []


# Option 2: Using OpenAI API
"""
class ChatBotClient:
    
    Chatbot client using OpenAI API
    
    Installation:
    1. pip install openai
    2. Set your API key: export OPENAI_API_KEY='your-key-here'
    
    
    def __init__(self, model="gpt-3.5-turbo"):
        
        Initialize OpenAI chatbot
        
        Args:
            model: OpenAI model name
        
        import os
        try:
            from openai import OpenAI
            
            api_key = os.getenv("OPENAI_API_KEY")
            if not api_key:
                raise ValueError("OPENAI_API_KEY not set")
            
            self.client = OpenAI(api_key=api_key)
            self.model = model
            self.conversation_history = []
            
        except ImportError:
            raise ImportError("OpenAI library not installed. Run: pip install openai")
    
    def chat(self, message):
        
        Send message to OpenAI and get response
        
        Args:
            message: User's message
            
        Returns:
            Bot's response
        
        try:
            # Add to conversation history
            self.conversation_history.append({
                "role": "user",
                "content": message
            })
            
            # Make API request
            response = self.client.chat.completions.create(
                model=self.model,
                messages=self.conversation_history,
                max_tokens=150,
                temperature=0.7
            )
            
            bot_response = response.choices[0].message.content
            
            # Add to conversation history
            self.conversation_history.append({
                "role": "assistant",
                "content": bot_response
            })
            
            # Keep only last 10 messages
            if len(self.conversation_history) > 20:
                self.conversation_history = self.conversation_history[-20:]
            
            return bot_response
            
        except Exception as e:
            return f"Error: {str(e)}"
    
    def reset_conversation(self):
        Clear conversation history
        self.conversation_history = []
"""


# Option 3: Simple Rule-Based Bot (No external dependencies)
"""
class ChatBotClient:
    
    Simple rule-based chatbot
    No external dependencies required
    
    
    def __init__(self):
        self.responses = {
            "hello": "Hello! How can I help you?",
            "hi": "Hi there! What can I do for you?",
            "how are you": "I'm doing great, thanks for asking!",
            "bye": "Goodbye! Have a great day!",
            "help": "I'm a simple chatbot. Try asking me about the weather, saying hello, or asking how I am!",
            "weather": "I don't have access to weather data, but I hope it's nice!",
            "name": "I'm ChatBot, your friendly assistant!",
            "thank": "You're welcome!"
        }
    
    def chat(self, message):
        
        Generate response based on keywords
        
        Args:
            message: User's message
            
        Returns:
            Bot's response
        
        message_lower = message.lower()
        
        # Check for keywords
        for keyword, response in self.responses.items():
            if keyword in message_lower:
                return response
        
        # Default response
        if '?' in message:
            return "That's an interesting question! I'm a simple bot, so I might not have the best answer."
        else:
            return f"I heard you say: '{message}'. I'm learning to understand more each day!"
    
    def reset_conversation(self):
        pass  # No history to reset
"""

if __name__ == "__main__":
    # Test the chatbot
    bot = ChatBotClient()
    
    print("Chatbot Test")
    print("Type 'quit' to exit")
    print("-" * 50)
    
    while True:
        user_input = input("You: ")
        if user_input.lower() in ['quit', 'exit', 'q']:
            break
        
        response = bot.chat(user_input)
        print(f"Bot: {response}")
        print()